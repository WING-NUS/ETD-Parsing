###### Version history:
* 2019-07-07: created by Jian Wu (fanchyna@gmail.com)

### GENERATE ANNOTATED CITATION STRINGS FROM ACM DL DATABASE RECORDS


This document contains instructions to generate automatically annotated citation strings from the ACM digital library (ACM DL) database records. This assumes the following datasets and programming environment are in place:
* The ACM DL database is imported into a local MySQL database. This database was obtained by first converting the original ACM DL data in XML into JSON formats and then inserting data from JSON files into the database. The database contains 3 tables: PAPER, AUTHOR, CITEGRAPH. 
* Python 3.4+ with the following dependency packages:
  * mysql.connector 
  * multiprocessing
* Bash 
* JDK 1.8+
* Scala 2.12.8+: this needs to be installed at `/usr/share/scala/lib/scala-library.jar` or a particular directory that will be specified for the `SCALA_HOME` variable later.

#### 1. The first step is to generate BibTex (.bib) files. 
Before doing this, edit the configuration file `config.py` to set the database name and login credentials. The `workdir` specifies the main working directory under which the output and log directories will be created. Then run
```bash
$ python3 db2bibtex.py -h
```
to see if you need to specify the output and log directories. If not specified, default directory paths will be created and used. `db2bibtex.py` will 
* save generated bibtex files for conferences and journal articles into separate folders under the output directory, and 
* ignore papers in which author fields are empty. 
The program will invoke the `multiprocessing_mapreduce.py` and try to parallelize the task into 50 workers. This parameter can be changed in the following line if desired:
```python3
mapper = SimpleMapReduce(dbrec_to_bibtex,count_type,num_workers=50)
```
The output directory contains two subdirectories: `conference/` and `journal/`. Each subdirectory contains a number of subfolders, each of which contains up to 1000 BibTex files. The folder names are generated by trimming off the last 3 digits of the `Article_ID` field of each paper. For example, if the `Article_ID` of a conference paper is `2008529`,  its BibTex file will be saved at `conference/2008/2008529.bib`. If the `Article_ID` is less than 1000, the corresponding BibTex files are saved under `0/`. 

Empirically, this step can take several hours within a day.

#### 2. The second step is to generate automatically annotated citation strings. 
Before doing this, we need to prepare for files required by `ref2bib-assembly-loop.sh`, which will parallelize the core program `ref2bib-assembly-0.1.1.jar`. First, we generate a text file containing a list of paths to the subfolders, e.g., `2008/`. This can be done using the following shell command (assuming the `workdir` is  `/data/workdir`):
```bash
$ find /data/workdir/conference -maxdepth 1 -type d > /data/workdir/list-files/conference.txt
$ find /data/workdir/journal -maxdepth 1 -type d > /data/workdir/list-files/journal.txt
```
The first rows in `conference.txt` may look like the following:
```
/data/workdir/conference
/data/workdir/conference/2402
/data/workdir/conference/1006
/data/workdir/conference/1756
/data/workdir/conference/1234
```
*The first row should be deleted as it is not a subfolder.*
Second, we further split each list file into 10 files each containing roughly 10% of subfolders. We do this because we will launch 10 sessions using the `screen` command to maximize the number of cores. This is because `ref2bib-assembly-0.1.1.jar` can only process one folder at a time and the max batch size is hardcoded to be 100 (required by the original coder Yuan Chuan Kee). The Linux command is
```
$ split -l 220 -d conference.txt conference.txt_
```
One should replace 220 with the actual number of lines desired in a file. This results in the following files 

```
conference.txt_00
conference.txt_01
...
```
Run a similar command for `journal.txt`. 

Next, edit `ref2bib-assembly-loop.sh` and change the `ANNOTATED_PATH` variable to be the directory to store the generated strings. For example,
```
ANNOTATED_PATH=/data/workdir/ref2bib-assembly-loop-jour
```
Set different paths for conferences and journals. The `CODE_PATH` denotes the path of the 
`ref2bib-assembly-0.1.1.jar`. The `BATCH_SIZE` is set to 100. The `STYLES` contains 17 citation styles, the names of which can be found in the long list of the CSL GitHub repository. One can edit this list if only certain styles need to be used for rendering. 

Next, open a screen session like
```
$ screen -S 0loop
```
and run the following commmand 
```
$ /ref2bib-assembly-loop.sh /data/workdir/list-files/conference.txt_00
```
The screen may print lines like
```
08:15:09.373 [scala-execution-context-global-24] WARN App - 1959/1959971.bib has BOM, however it has been ignored.
08:15:09.407 [scala-execution-context-global-24] WARN App - 1959/1959366.bib has BOM, however it has been ignored.
```
This is normal. Detach this session (hold Ctrl, press "a" and then press "d") and open the second session using
```
$ screen -S 1loop
```
and run a similar command for `conference.txt_01`. Do this for all conference lists. Wait until all conference lists are finished, then run the journal lists. Remember to modify the `ANNOTATED_PATH` before starting the bash script. 

The resulting files are organized in the following way like
```
ref2bib-assembly-loop-conf/african-online-scientific-information-systems-harvard
ref2bib-assembly-loop-conf/annual-reviews
ref2bib-assembly-loop-conf/apa
ref2bib-assembly-loop-conf/cambridge-university-press-author-date
ref2bib-assembly-loop-conf/chicago-author-date
ref2bib-assembly-loop-conf/current-opinion
ref2bib-assembly-loop-conf/elsevier-harvard
ref2bib-assembly-loop-conf/elsevier-vancouver
ref2bib-assembly-loop-conf/ieee
ref2bib-assembly-loop-conf/nature
ref2bib-assembly-loop-conf/oxford-the-university-of-new-south-wales
ref2bib-assembly-loop-conf/springer-humanities-author-date
ref2bib-assembly-loop-conf/springer-mathphys-brackets
ref2bib-assembly-loop-conf/springerprotocols
ref2bib-assembly-loop-conf/taylor-and-francis-harvard-x
ref2bib-assembly-loop-conf/wiley-vch-books
ref2bib-assembly-loop-conf/modern-language-association-7th-edition
```
Each directory contains about 2000 files named like `output_2008.txt`. The number `2008` corresponds to the subfolder above. The total number of rows in this file should be equal to the number of BibTex files under `/data/workdir/conference/2008`.

_Step 2 is very computationally expensive._ Empirically, it took up to 6 days on a server with 96 cores (100% used). The requirement to the memory is not very high, but a server with such high CPUs usually has high memory as well. 
